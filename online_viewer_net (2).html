<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#09090b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>FlowFocus | Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* --- Reset & Base --- */
        * { -webkit-tap-highlight-color: transparent; -webkit-user-select: none; user-select: none; touch-action: manipulation; }
        input { -webkit-user-select: text; user-select: text; }

        :root {
            --theme: #fbbf24;
            --ui-scale: 1;
            --glass-bg: rgba(22, 22, 24, 0.75);
            --glass-border: rgba(255, 255, 255, 0.08);
            --app-bg: #09090b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--app-bg);
            color: white;
            overflow: hidden;
            height: 100dvh;
            width: 100vw;
            display: flex; flex-direction: column;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            transition: background-image 0.5s ease;
        }

        /* --- Layers --- */
        .layer { position: fixed; inset: 0; width: 100%; height: 100%; object-fit: cover; transition: opacity 0.5s; pointer-events: none; }
        #bg-layer { z-index: -3; background-size: cover; background-position: center; }
        #video-layer { z-index: -2; opacity: 0; }
        #overlay-layer { z-index: -1; background: rgba(0,0,0,0.4); }

        /* --- UI Components --- */
        .app-header { padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; z-index: 50; transition: opacity 0.3s, transform 0.3s; }
        
        .icon-btn { 
            width: 2.75rem; height: 2.75rem; border-radius: 50%; 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05); 
            color: #a1a1aa; display: flex; align-items: center; justify-content: center; 
            transition: all 0.2s; cursor: pointer; 
        }
        .icon-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.1); color: white; }

        .surface { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; z-index: 10; width: 100%; transition: all 0.5s ease; }
        
        .glass-panel {
            background: var(--glass-bg); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--glass-border); box-shadow: 0 20px 50px -12px rgba(0,0,0,0.5);
            border-radius: calc(1.5rem * var(--ui-scale)); padding: calc(2rem * var(--ui-scale));
            width: min(92%, 26rem); display: flex; flex-direction: column; align-items: center;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); max-height: 85vh;
        }

        /* --- Timer Digits --- */
        .timer-display {
            font-family: 'JetBrains Mono', monospace; 
            font-size: clamp(3.5rem, 15vw, 6rem); 
            font-weight: 700; color: var(--theme); 
            display: flex; gap: 0.25rem; 
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
            margin: 1rem 0; cursor: pointer;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); /* Bouncy scale */
        }
        .t-card {
            background: linear-gradient(180deg, #27272a 0%, #18181b 100%);
            padding: 0.1em 0.2em; border-radius: 0.2em; border: 1px solid rgba(255,255,255,0.05);
            position: relative; overflow: hidden; min-width: 0.6em; text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: background 0.3s, border 0.3s, box-shadow 0.3s;
        }
        .t-card::after { content: ''; position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: rgba(0,0,0,0.5); box-shadow: 0 1px 0 rgba(255,255,255,0.05); transition: opacity 0.3s; }
        .flip-anim { animation: flip 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes flip { 0% { transform: rotateX(0deg); } 50% { transform: rotateX(-90deg); opacity: 0.5; } 100% { transform: rotateX(0deg); opacity: 1; } }

        /* --- Lofi Bot & Notes --- */
        .bot-container { width: calc(6rem * var(--ui-scale)); height: calc(6rem * var(--ui-scale)); margin-bottom: 0.5rem; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.4)); transition: transform 0.2s; cursor: pointer; position: relative; }
        .bot-container:active { transform: scale(0.95); }
        
        .bot-idle .zzz { opacity: 1; animation: floatUp 2s infinite; }
        .bot-idle .open, .bot-idle .mug, .bot-idle .note, .bot-work .zzz, .bot-work .closed, .bot-work .mug, .bot-break .zzz, .bot-break .closed, .bot-break .note { display: none; }
        .bot-idle .closed, .bot-work .open, .bot-break .open, .bot-break .mug { display: block; }
        .bot-work .head { animation: bob 0.6s infinite ease-in-out; }
        .bot-work .note { display: block; opacity: 0; animation: floatNote 2s infinite; }
        .bot-break .mug { opacity: 1; animation: sip 3s infinite; }

        @keyframes floatUp { 0% { opacity: 0; transform: translate(0,0); } 50% { opacity: 1; } 100% { opacity: 0; transform: translate(10px, -15px); } }
        @keyframes floatNote { 0% { opacity: 0; transform: translate(0,0) rotate(0deg); } 50% { opacity: 1; } 100% { opacity: 0; transform: translate(-10px, -20px) rotate(-15deg); } }
        @keyframes bob { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(2px); } }
        @keyframes sip { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-3px) rotate(-8deg); } }

        /* --- Task Manager --- */
        .task-section { width: 100%; margin-top: 1.5rem; display: flex; flex-direction: column; gap: 0.5rem; transition: opacity 0.3s; }
        .task-input { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; padding: 0.8rem; width: 100%; outline: none; transition: border-color 0.2s; font-size: 0.9rem; }
        .task-input:focus { border-color: var(--theme); }
        .task-list { max-height: 120px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; }
        .task-item { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.03); padding: 0.6rem 0.8rem; border-radius: 8px; animation: slideIn 0.2s; }
        .task-item.done span { text-decoration: line-through; color: #71717a; }
        .task-check { width: 20px; height: 20px; border-radius: 50%; border: 2px solid #52525b; margin-right: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .task-item.done .task-check { background: var(--theme); border-color: var(--theme); color: black; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Buttons --- */
        .btn-primary { 
            background: var(--theme); color: #09090b; width: 100%; padding: 1rem; 
            border-radius: 1rem; font-size: 1.1rem; font-weight: 700; 
            display: flex; align-items: center; justify-content: center; gap: 0.5rem; 
            box-shadow: 0 0 25px -5px var(--theme); transition: all 0.2s; margin-top: 1rem; 
        }
        .btn-primary:active { transform: scale(0.96); filter: brightness(0.9); }

        /* --- Notifications Toast --- */
        .notify-toast {
            position: fixed; top: env(safe-area-inset-top); margin-top: 1rem; left: 50%; transform: translateX(-50%) translateY(-200%);
            background: rgba(20, 20, 20, 0.95); backdrop-filter: blur(15px);
            border: 1px solid var(--theme); border-radius: 16px; padding: 1rem;
            width: 90%; max-width: 350px; z-index: 200; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; gap: 0.5rem; transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .notify-toast.show { transform: translateX(-50%) translateY(0); }
        .notify-actions { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
        .btn-action { flex: 1; padding: 0.6rem; border-radius: 8px; font-size: 0.9rem; font-weight: 600; text-align: center; cursor: pointer; transition: background 0.2s; }
        .btn-action.break { background: var(--theme); color: black; }
        .btn-action.snooze { background: rgba(255,255,255,0.1); color: white; }

        /* --- Settings Sheet --- */
        .sheet-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .sheet-backdrop.open { opacity: 1; pointer-events: auto; }
        .sheet { position: fixed; bottom: 0; left: 0; right: 0; background: #121214; border-top: 1px solid rgba(255,255,255,0.1); border-radius: 24px 24px 0 0; padding: 1.5rem; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 101; max-height: 85vh; overflow-y: auto; padding-bottom: max(1.5rem, env(safe-area-inset-bottom)); }
        .sheet.open { transform: translateY(0); }
        .sheet-handle { width: 36px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; margin: 0 auto 1.5rem auto; }
        
        .control-row { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 12px; margin-bottom: 0.5rem; }
        .ios-toggle { appearance: none; width: 50px; height: 30px; background: #3f3f46; border-radius: 99px; position: relative; transition: background 0.3s; cursor: pointer; }
        .ios-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 26px; height: 26px; background: white; border-radius: 50%; transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .ios-toggle:checked { background: var(--theme); }
        .ios-toggle:checked::after { transform: translateX(20px); }

        /* --- FOCUS MODE (Landscape & Fullscreen Fix) --- */
        body.focus-active .app-header { opacity: 0; pointer-events: none; transform: translateY(-20px); }
        
        /* Transform Glass Panel into Invisible Container */
        body.focus-active .glass-panel { 
            background: transparent; border: none; box-shadow: none; backdrop-filter: none; -webkit-backdrop-filter: none;
            width: 100vw; height: 100vh; max-height: none; justify-content: center; padding: 0;
        }

        /* Scale Timer Up */
        body.focus-active .timer-display { 
            font-size: 25vw; /* Massive size */
            text-shadow: 0 10px 60px rgba(0,0,0,0.9); /* Strong shadow for readability over any image */
            gap: 1vw;
        }

        /* Make Cards Invisible Containers */
        body.focus-active .t-card { 
            background: transparent; border: none; box-shadow: none; padding: 0;
        }
        body.focus-active .t-card::after { display: none; } /* Remove split line */

        /* Hide Non-Essentials */
        body.focus-active .bot-container, 
        body.focus-active #mode-list, 
        body.focus-active .task-section, 
        body.focus-active #mainBtn,
        body.focus-active .glass-panel > div.flex /* Footer controls */ { 
            display: none !important; 
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body ondblclick="toggleFocusMode()"> <!-- Double tap background to toggle -->

    <!-- Backgrounds -->
    <div id="bg-layer" class="layer" style="background-image: radial-gradient(circle at center, #1e1e24, #000);"></div>
    <video id="video-layer" class="layer" loop muted playsinline></video>
    <div id="overlay-layer" class="layer"></div>

    <!-- Notification Toast -->
    <div id="notifyToast" class="notify-toast">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-xl">ðŸŽ‰</div>
            <div>
                <div class="font-bold text-sm" id="toastTitle">Session Complete</div>
                <div class="text-xs text-gray-400" id="toastMsg">Great job! Time to recharge.</div>
            </div>
        </div>
        <div class="notify-actions">
            <div class="btn-action break" onclick="handleAction('break')">Start Break</div>
            <div class="btn-action snooze" onclick="handleAction('snooze')">Snooze 5m</div>
        </div>
    </div>

    <!-- Header -->
    <header class="app-header">
        <div class="flex items-center gap-2 opacity-80" onclick="toggleFocusMode()">
            <i class="fa-solid fa-layer-group text-lg" style="color: var(--theme)"></i>
            <span class="font-bold tracking-tight">FlowFocus</span>
        </div>
        <div class="flex gap-3">
            <button onclick="document.getElementById('fileInput').click()" class="icon-btn"><i class="fa-solid fa-image"></i></button>
            <button onclick="toggleSettings()" class="icon-btn"><i class="fa-solid fa-sliders"></i></button>
        </div>
        <input type="file" id="fileInput" accept="image/*,video/*" hidden onchange="handleUpload(this)">
    </header>

    <!-- Main Surface -->
    <div class="surface">
        <div class="glass-panel">
            
            <!-- Lofi Bot -->
            <div id="bot" class="bot-container bot-idle" onclick="toggleTimer()">
                <svg viewBox="0 0 100 100" class="w-full h-full drop-shadow-xl">
                    <g class="zzz" fill="white" font-family="monospace" font-weight="bold"><text x="75" y="20" font-size="20">Z</text><text x="85" y="10" font-size="14">z</text></g>
                    <g class="note" fill="var(--theme)" style="display:none"><path d="M10 40 Q20 30 30 40 T50 40" stroke="var(--theme)" stroke-width="2" fill="none"/><circle cx="10" cy="40" r="2"/><circle cx="50" cy="40" r="2"/></g>
                    <g class="head">
                        <rect x="25" y="30" width="50" height="40" rx="10" fill="#27272a" stroke="var(--theme)" stroke-width="2"/>
                        <rect x="30" y="35" width="40" height="25" rx="5" fill="#09090b"/>
                        <g class="open"><circle cx="40" cy="48" r="3" fill="var(--theme)"/><circle cx="60" cy="48" r="3" fill="var(--theme)"/></g>
                        <g class="closed"><path d="M37 48 h6" stroke="var(--theme)" stroke-width="2"/><path d="M57 48 h6" stroke="var(--theme)" stroke-width="2"/></g>
                    </g>
                    <g class="body">
                        <path d="M30 70 L70 70 L65 95 L35 95 Z" fill="#27272a"/>
                        <rect class="arm arm-l" x="20" y="70" width="12" height="20" rx="4" fill="#52525b"/>
                        <rect class="arm arm-r" x="68" y="70" width="12" height="20" rx="4" fill="#52525b"/>
                    </g>
                    <g class="mug"><path d="M75 65 h8 v10 h-8 Z M83 67 h3 v6 h-3 Z" fill="var(--theme)"/></g>
                </svg>
            </div>

            <!-- Mode Selector -->
            <div class="w-full overflow-x-auto flex gap-2 mb-2 no-scrollbar" id="mode-list"></div>

            <!-- Timer -->
            <div class="timer-display" onclick="toggleTimer()">
                <div class="t-card"><span id="m1">2</span></div>
                <div class="t-card"><span id="m2">5</span></div>
                <span style="opacity:0.5">:</span>
                <div class="t-card"><span id="s1">0</span></div>
                <div class="t-card"><span id="s2">0</span></div>
            </div>

            <!-- Task Manager -->
            <div class="task-section">
                <form onsubmit="addTask(event)" class="relative">
                    <input type="text" id="taskInput" placeholder="Add a focus task..." class="task-input">
                    <button type="submit" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white"><i class="fa-solid fa-plus"></i></button>
                </form>
                <div id="taskList" class="task-list custom-scrollbar"></div>
                <div class="text-xs text-center text-gray-500 mt-1" id="taskCount">0 tasks</div>
            </div>

            <!-- Action Button -->
            <button onclick="toggleTimer()" id="mainBtn" class="btn-primary">
                <i class="fa-solid fa-play"></i> START
            </button>
            <div class="flex justify-between w-full px-4 mt-2">
                <button onclick="resetTimer()" class="text-gray-500 hover:text-white p-2"><i class="fa-solid fa-rotate-right"></i></button>
                <button onclick="toggleFocusMode()" class="text-gray-500 hover:text-white p-2"><i class="fa-solid fa-expand"></i></button>
            </div>

        </div>
    </div>

    <!-- Settings Sheet -->
    <div id="backdrop" class="sheet-backdrop" onclick="toggleSettings()"></div>
    <div id="settingsSheet" class="sheet">
        <div class="sheet-handle"></div>
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-lg">Settings</h3>
            <button onclick="toggleSettings()" class="w-8 h-8 flex items-center justify-center bg-white/5 rounded-full"><i class="fa-solid fa-xmark"></i></button>
        </div>
        
        <div class="space-y-4">
            <!-- Theme -->
            <div class="control-row">
                <span class="text-sm">Accent Color</span>
                <div class="flex gap-2">
                    <button onclick="setTheme('#fbbf24')" class="w-6 h-6 rounded-full bg-amber-400"></button>
                    <button onclick="setTheme('#ef4444')" class="w-6 h-6 rounded-full bg-red-500"></button>
                    <button onclick="setTheme('#3b82f6')" class="w-6 h-6 rounded-full bg-blue-500"></button>
                    <button onclick="setTheme('#10b981')" class="w-6 h-6 rounded-full bg-emerald-500"></button>
                    <input type="color" class="w-6 h-6 rounded-full p-0 border-0" oninput="setTheme(this.value)">
                </div>
            </div>

            <!-- Toggles -->
            <div class="control-row">
                <span class="text-sm">Sound Effects</span>
                <input type="checkbox" id="soundToggle" class="ios-toggle" checked onchange="saveSys()">
            </div>
            <div class="control-row">
                <span class="text-sm">Haptics</span>
                <input type="checkbox" id="vibeToggle" class="ios-toggle" checked onchange="saveSys()">
            </div>
            <div class="control-row">
                <span class="text-sm">Notifications</span>
                <input type="checkbox" id="notifyToggle" class="ios-toggle" onchange="reqNotify()">
            </div>
            <div class="control-row">
                <span class="text-sm">Keep Screen On</span>
                <input type="checkbox" id="wakeToggle" class="ios-toggle" onchange="toggleWake()">
            </div>

            <!-- Custom Timer -->
            <div class="p-4 bg-white/5 rounded-xl mt-4">
                <label class="text-xs uppercase text-gray-500 font-bold block mb-2">Create Mode</label>
             